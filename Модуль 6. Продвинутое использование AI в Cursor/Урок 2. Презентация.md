[[Урок 2. AI-driven Debugging и поиск багов]]
## **Слайд 1 — Титульный

**Заголовок:** AI-driven Debugging: как искать и чинить баги быстрее

**Подзаголовок:** Триаж → Гипотезы → Диагностика → Фикс → Регресс-тест

**Notes:** цель — научиться ставить задачи AI на каждом этапе отладки и получать **проверяемые** результаты (диффы, тесты, таймлайны).

---

## **Слайд 2 — План и результат**

**Тезисы:**

1. Поиск ошибок: статанализ + “пахнущие” места
    
2. Логи/трейсы: как просить у AI таймлайн и гипотезы
    
3. Фиксы как **diff** + регресс-тесты
    
4. Практика: реальный баг → от симптома до PR
    
    **Итог:** чек-лист отладки, библиотека промптов, шаблон регресс-теста.

---

### **БЛОК 1. ТРИАЖ И МИНИ-РЕПРО

## **Слайд 3 — Каркас отладки**

**Тезисы:** Симптом → Сигналы → Гипотезы → Эксперименты → Фикс → Регресс.

**Notes:** всегда начинаем с **минимального воспроизведения** и критериев успеха.

**Промпт (триаж):**

«Суммаризируй проблему: что сломано, где, частота, версии. Сформируй 3–5 гипотез с приоритетами и план мини-репро (шаги и ожидаемые результаты).»

---

## **Слайд 4 — Просим AI найти «горячие зоны»**

**Тезисы:**

- Статические запахи: неконтролируемые промисы, мутации, расхождение типов, N+1, гонки
    
- Потенциальные уязвимости (инъекции/ХSS/CSRF)
    
    **Промпт:**
    
    «Проанализируй этот файл/дифф на 10 типичных ошибок (async, типы, границы, безопасность). Верни список рисков с конкретными строками и кратким фикс-планом.»

---

### **БЛОК 2. ПОИСК ОШИБОК В КОДЕ

## **Слайд 5 — Пример: “тихий” async-баг (TS/Express)**

```
// bug: ошибка в обработчике не попадает в error middleware
app.get("/profile", async (req, res) => {
  const user = await repo.findById(req.query.id as string) // может бросить
  res.json(user)
})
```

**AI-фикс (ожидаем как diff):** обернуть в try/catch и вызывать next(err) или использовать обёртку-хелпер.

**Промпт:**

«Найди, где исключение теряется и почему 500 не логируется. Верни **unified diff** с исправлением и тест supertest на 500.»

---

## **Слайд 6 — Пример: утечка через таймер**

```
const timers = new Map<string, NodeJS.Timeout>()
export function track(id: string) {
  if (!timers.has(id)) timers.set(id, setInterval(()=> doWork(id), 1000))
}
// bug: нет clearInterval при завершении/ошибке
```

**Промпт:**

«Предложи стратегию очистки и напиши юнит-тест на утечки (имитация таймера, подсчёт активных). Верни diff + тест.»

---

### **БЛОК 3. ЛОГИ, ТРЕЙСЫ И ДИАГНОСТИКА

## **Слайд 7 — Как «скормить» логи AI**

**Тезисы:**

- Лучше **структурные** логи (JSON) и **correlationId**
    
- Сравнение “хорошо vs сломано” → дифф закономерностей
    
    **Промпт (таймлайн из логов):**
    
    «Вот 200 строк логов (JSON) с ts и requestId. Построй таймлайн для requestId=…, выдели отклонения от “нормального” запроса и предложи 3 гипотезы причины с вероятностями.»


**Мини-пример лога:**

```
{"ts":"12:00:00.100","rid":"abc","span":"auth","msg":"ok"}
{"ts":"12:00:00.120","rid":"abc","span":"booking","msg":"lock_acquire","room":42}
{"ts":"12:00:01.500","rid":"abc","span":"booking","level":"warn","msg":"lock_timeout"}
```

---

## **Слайд 8 — Диагностика по метрикам/трейсам**

**Тезисы:**

- p95 вырос? спросите AI «какие спаны шумят»
    
- Нетошные “хвосты” → очереди/блокировки/DNS
    
    **Промпт:**
    
    «По этим трейс-спанам выдели топ-3 узких места и предложи експерименты (включая временные флаги/кэш/батчинг).»

---

## **Слайд 9 — Инструментирование “на лету”**

**Тезисы:**

- Просим AI сгенерировать точки логирования/трейсинга
    
- Формат логов: уровень, ключи, rid, время, поля домена
    
    **Промпт:**
    
    «Добавь структурные логи и трейс-спаны в функции X/Y. Верни diff с полями: level, rid, event, duration, важные параметры. Не логируй PII.»

---

### **БЛОК 4. ПРАКТИКА: РЕАЛЬНЫЙ БАГ

## **Слайд 10 — Сценарий практики**

**Задание:**

1. Вставьте баг (например, таймзона: new Date().toISOString() в локальной логике дедлайна).
    
2. Попросите AI: триаж → гипотезы → план репро.
    
3. Дайте логи 2 запросов (норма/сбой) и попросите таймлайн.
    
4. Получите **diff** фикса + тест (edge-cases).
    
    **Критерии:** баг воспроизводим; тест красный → зелёный; логика не сломана в соседних кейсах.

**Промпт (фиксация регресса):**

«Сгенерируй тесты, закрывающие кейсы: UTC vs local, конец месяца, локали с DST. Не меняй публичный API.»

---

## **Слайд 11 — Инструменты ускорения**

**Тезисы:**

- git bisect с подсказками AI (шаги/команды)
    
- Фича-флаги/канареечный релиз — безопасная проверка гипотез
    
- **Property-based** и **fuzz-тесты** для “скользких” функций
    
    **Промпт:**
    
    «Подготовь bisect-план (критерий “плохого” билда) и команды. Дай скрипт быстрой проверки (exit 0/1).»

---

### **БЛОК 5. ЧЕК-ЛИСТЫ, ПАТТЕРНЫ, ПРОМПТЫ

## **Слайд 12 — Чек-лист отладки**

- Симптом и критерий “исправлено” зафиксированы
    
- Мини-репро получен (шаги/данные)
    
- Гипотезы приоритезированы (1–3)
    
- Логи/трейсы с rid и таймлайном
    
- Фикс как **diff**, покрыт тестом
    
- Релиз: канарейка/фича-флаг, мониторинг после выката

---

## **Слайд 13 — Частые баги и как просить AI**

**Категории:**

- **Async/гонки:** “двойная отправка”, потерянные ошибки → «покажи участки без await/return»
    
- **Таймзоны/даты:** off-by-one → «нарисуй диаграмму переходов дат»
    
- **Состояние UI:** stale-closures, неправильные deps хука → «проверь зависимости useEffect»
    
- **Производительность:** N+1, тяжёлые синхронные участки → «построй тепловую карту сложностей»

**Промпт-шаблон:**

«Найди возможные конкурирующие условия/утечки/блокировки в модуле X. Верни список подозрительных мест с код-строками и предложи минимальные изменения.»

---

## **Слайд 14 — Анти-паттерны**

- «Сразу переписать всё» вместо минимального фикса
    
- Лить в AI гигабайты логов без фильтров → шум и цена
    
- Фикс без теста и без понимания причины
    
- Логирование PII/секретов
    
    **Notes:** лечится: пакетная работа, фильтры, diff+тест, политика логов.

---

## **Слайд 15 — Подсказки промптов (шпаргалка)**

- «Суммаризируй инцидент и дай top-3 гипотезы по логам.»
    
- «Построй таймлайн запроса rid=... и сравни с нормой.»
    
- «Верни **только unified diff** фикса и *.test.* с edge-кейсами.»
    
- «Сгенерируй точки логирования и формат JSON-логов (без PII).»
    
- «Сделай bisect-план и fast-check скрипт (exit-код).»

---

## **Слайд 16 — Итоги

**Тезисы:**

- AI ускоряет триаж, гипотезы и фикс, но результат должен быть **проверяемым**
    
- Нормализуйте логи/трейсы, держите библиотеку промптов