[[Урок 2. AI-чат рефакторинг и улучшение кода]]
## **Слайд 1 — Титульный (0:00–3:00)**

**Заголовок:** Рефакторинг и улучшение кода с AI-чатом

**Подзаголовок:** Функции · Баги · Оптимизация · Читаемость

**Тезисы:** AI-чат = инструмент для осмысленных изменений кода

**Notes (3:00):** «Сегодня: как ставить задачу AI для рефакторинга, поиска багов и оптимизации, проверяя результат тестами и diff.»

---

## **Слайд 2 — Алгоритм работы с AI-рефакторингом**

**Тезисы:**

1. Сформулируй цель и ограничения
    
2. Сузь контекст (файлы/папки, публичные API)
    
3. Попроси **diff** и краткое обоснование
    
4. Прогони тесты и линтер
    
5. Закоммить отдельно
    
    **Notes (1:30):** напомните: коммит перед крупными правками — обязательно.  

**Промпт-шаблон:**

«Рефакторинг **только** в src/utils/date.ts. Сохрани публичные сигнатуры. Улучши читаемость и сложность. Верни изменения в формате **diff** + список рисков.»

---

## **Слайд 3 — Виды рефакторинга: что просить у AI**

**Тезисы:**

- Упрощение логики (guard-ветки, early return)
    
- Разбиение на функции/модули
    
- Избавление от дубликатов (DRY)
    
- Выделение «чистого ядра» и слоя работы с IO
    
    **Notes (1:30):** просите примеры до/после и объяснение «зачем».
    

---

## **Слайд 4 — Пример «до»: запутанная функция**

**Тезисы:** короткий фрагмент с «ароматами кода»

**Сниппет (до):**

```
export function applyDiscount(items: Item[], rate?: number) {
  let r = rate || 0;
  for (let i = 0; i < items.length; i++) {
    if (items[i] && items[i].price) {
      if (r > 0) {
        items[i].price = items[i].price - (items[i].price * r);
      }
      if (items[i].category === "vip") {
        items[i].price = items[i].price * 0.95;
      }
    }
  }
  return items;
}
```

**Notes (1:30):** покажите проблемы: мутация входа, дублирование, скрытые правила.

---

## **Слайд 5 — Пример «после»: запрос к AI и результат**

**Тезисы:** чистая функция, предикаты, иммутабельность

**Промпт:**

«Перепиши в функциональном стиле, без мутации входа, с понятными именами и guard-ветками. Сохрани поведение. Верни diff + объяснение.»

**Сниппет (после, фрагмент):**

```
export function applyDiscount(items: Item[], rate = 0): Item[] {
  const discount = (p: number, r: number) => p - p * r;
  return items.map((x) => {
    if (!x?.price) return x;
    const base = rate > 0 ? discount(x.price, rate) : x.price;
    const final = x.category === "vip" ? discount(base, 0.05) : base;
    return { ...x, price: final };
  });
}
```

**Notes (2:00):** подчеркните: иммутабельность и именованные шаги.

---

## **Слайд 6 — Контракт не меняем: API-стабильность**

**Тезисы:**

- Публичные сигнатуры/типы/файловая структура — фиксированы
    
- Допускаются внутренние изменения и разбиение
    
    **Notes (1:00):** всегда просите AI перечислить, что **не** изменялось.

**Промпт:**

«Не меняй экспортируемые имена и сигнатуры. Перечисли, что осталось прежним.»

---

## **Слайд 7 — Поиск багов с AI

**Тезисы:**

- Типичные дефекты: nullable, границы, асинхронщина, гонки, N+1
    
- Сфокусируй AI на «как сломать»
    
    **Notes (2:00):** просите примеры входов, при которых функция падает.

**Промпт:**

«Проанализируй applyDiscount. Дай список **возможных багов** с примерами входных данных, которые ломают функцию. Предложи фиксы (diff).»

---

## **Слайд 8 — Оптимизация алгоритмов (часть 2)

**Тезисы:**

- Снижаем сложность/аллокации, убираем двойные проходы
    
- Кеширование/мемоизация, отказ от лишних сортировок
    
    **Notes (2:00):** попросите замеры и оценку сложности.

**Промпт:**

«Оптимизируй по времени/памяти. Оцени сложность до/после. Покажи только diff и поясни trade-offs.»

---

## **Слайд 9 — Когда «ускорять» не надо**

**Тезисы:**

- Преждевременная оптимизация против понятности
    
- Сначала профилировать, потом менять
    
    **Notes (1:00):** добавьте правило: «читабельность > микро-выигрыш».

---

## **Слайд 10 — Улучшение читаемости

**Тезисы:**

- Переименование переменных и функций (domain-орiented)
    
- Комментарии «зачем», а не «что»
    
- Вынос магических чисел и условий
    
    **Notes (2:00):** просите AI предложить словарь имен в стиле домена.

**Промпт:**

«Предложи новые имена и краткие комментарии (только где сложно). Вынеси магические числа в константы. Верни diff.»

---

## **Слайд 11 — Ограничение области воздействия**

**Тезисы:**

- Работать в папке/файле, игнорировать тесты/бандлы
    
- Запретить изменения публичного API
    
    **Notes (1:00):** снижайте риск «залива» ненужных правок.

**Промпт:**

«Работай **только** в src/utils/. Не трогай api/, тесты и конфиги. Если требуется — предложи список follow-up задач вместо правок.»

---

## **Слайд 12 — Просим именно** diff и пояснение

**Тезисы:**

- Diff проще проверять и коммитить
    
- Короткое обоснование — зачем изменение
    
    **Notes (1:00):** AI должен объяснить каждый кусок.

**Промпт:**

«Верни ответ в формате unified diff. На каждый хунк — 1–2 предложения, зачем он нужен.»

---

## **Слайд 13 — Тесты как гарантия рефакторинга**

**Тезисы:**

- Юнит-тесты до/после: поведение неизменно
    
- Snapshot-тесты для сериализации/рендера
    
    **Notes (1:30):** просите AI **добавлять** тесты, а не переписывать все.

**Промпт:**

«Добавь юнит-тесты к applyDiscount: пустой массив, VIP, rate=0, смешанные кейсы. Не меняй имеющиеся тесты. Scripts обнови минимально.»

---

## **Слайд 14 — Микро-демо

**Задача:** рефакторим функцию → ловим баг → добавляем тест

**Шаги:**

1. Открыть функцию «до» (Слайд 4).
    
2. **Cmd/Ctrl+K** → промпт на рефакторинг (Слайд 5) с ограничениями.
    
3. Принять **diff**, запустить тесты (падают? — к Слайду 7).
    
4. Промпт на баг-анализ → принять фикс как diff.
    
5. Добавить тесты (Слайд 13) → зелёный.
    
    **Notes:** держите заготовленный проект/скрипты тестов.
    

---

## **Слайд 15 — Практика

**Задание:**

- Выберите «пахнущую» функцию в учебном проекте
    
- Попросите AI: рефакторинг с сохранением сигнатуры (diff)
    
- Попросите AI: 2 потенциальные ошибки + фиксы
    
- Добавьте по одному тесту на каждый фикс
    
    **Критерии:** API не менялся; diff проверен; тесты зелёные.
    

---

## **Слайд 16 — Анти-паттерны и как их избегать**

**Тезисы:**

- «Сделай лучше как считаешь» — без рамок → хаос
    
- Применять большие пачки без чтения diff
    
- Реалии: AI может «починить» одно и сломать другое
    
    **Notes (1:30):** страхуемся: ветка, маленькие коммиты, тесты.

---

## **Слайд 17 — Шаблоны промптов

- «Перепиши функцию **без изменения публичного API**. Улучши читаемость: guard-ветки, новые имена, разбиение. Верни **diff** + краткое обоснование на каждый хунк.»
    
- «Найди потенциальные баги (nullable/границы/асинхронность). Дай входы, которые ломают код, и **diff** с фиксом.»
    
- «Оптимизируй по времени/памяти. Оцени сложность до/после. Верни только **diff** и список trade-offs.»
    
- «Добавь 4 юнит-теста, не меняя существующие. Объясни, какую ветку поведения закрывает каждый тест.»

---

## **Слайд 18 — Итоги

**Тезисы:**

- AI-чат пригоден для рефакторинга, баг-ханта и оптимизации
    
- Ограничения + diff + тесты = безопасные изменения